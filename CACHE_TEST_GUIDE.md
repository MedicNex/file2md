# File2MD 缓存功能测试指南

## 📋 测试概述

本指南提供了完整的缓存功能测试方案，用于验证 `file.medicnex.com` 上部署的 Redis 缓存系统是否正常工作。

## 🚀 快速开始

### 方式 1: 使用 Python 测试脚本（推荐）

```bash
# 1. 确保有 Python 3 和 requests 库
pip3 install requests

# 2. 运行完整测试
python3 test_cache_functionality.py
```

### 方式 2: 使用 Shell 脚本

```bash
# 1. 给脚本执行权限
chmod +x test_cache_curl.sh

# 2. 运行快速测试
./test_cache_curl.sh
```

## ⚙️ 配置修改

在运行测试前，请确认以下配置：

### Python 脚本配置 (`test_cache_functionality.py`)

```python
# 第13-17行，修改为实际配置
BASE_URL = "https://file.medicnex.com"  # 或 http://file.medicnex.com
API_KEY = "file2md-2024-secure-key"     # 您的实际API密钥
```

### Shell 脚本配置 (`test_cache_curl.sh`)

```bash
# 第5-6行，修改为实际配置
BASE_URL="https://file.medicnex.com"    # 或 http://file.medicnex.com
API_KEY="file2md-2024-secure-key"      # 您的实际API密钥
```

## 🧪 测试项目

### 1. 健康检查测试
- ✅ 验证API服务是否正常
- ✅ 检查缓存组件状态
- ✅ 确认Redis连接正常

### 2. 缓存统计测试
- ✅ 获取当前缓存状态
- ✅ 查看缓存条目数量
- ✅ 检查Redis版本和内存使用

### 3. 基本缓存功能测试
- ✅ 首次上传文件（不命中缓存）
- ✅ 重复上传文件（命中缓存）
- ✅ 性能提升验证
- ✅ 响应时间对比

### 4. 相同内容不同文件名测试
- ✅ 验证基于内容哈希的缓存
- ✅ 确认文件名不影响缓存命中

### 5. 缓存清理测试
- ✅ 执行缓存清理操作
- ✅ 验证清理效果

## 📊 预期测试结果

### 成功的测试结果示例：

```
🚀 File2MD 缓存功能完整测试
测试目标: https://file.medicnex.com
测试时间: 2024-01-15 10:30:00

============================================================
  健康检查测试
============================================================
✅ PASS API健康检查
    状态: OK
✅ PASS 缓存组件
    状态: ENABLED

============================================================
  缓存统计查看
============================================================
✅ PASS 缓存统计获取
    缓存启用: True
    缓存条目数: 5
    Redis版本: 7.0.0
    内存使用: 2.1MB
    缓存TTL: 24小时

============================================================
  基本缓存功能测试
============================================================

🔸 第一次上传（预期：不命中缓存）
✅ PASS 首次文件上传
    耗时: 1250ms, 服务器处理: 1200ms
    来自缓存: False
    文件大小: 867 bytes
    内容长度: 1543 字符

🔸 第二次上传（预期：命中缓存）
✅ PASS 重复文件上传
    耗时: 150ms, 服务器处理: 100ms
    来自缓存: True
    文件大小: 867 bytes
    内容长度: 1543 字符
    缓存查询耗时: 5ms

🔸 缓存效果分析
✅ PASS 缓存命中验证
    第二次请求命中缓存
✅ PASS 性能提升验证
    速度提升: 88.0% (1250ms → 150ms)

============================================================
  测试总结
============================================================
通过测试: 5/5 (100.0%)
🎉 所有缓存功能测试通过！Redis缓存工作正常。
```

## 🔧 手动测试命令

如果需要单独测试某个功能，可以使用以下 curl 命令：

### 1. 健康检查
```bash
curl -X GET "https://file.medicnex.com/v1/health"
```

### 2. 缓存统计
```bash
curl -X GET \
  -H "Authorization: Bearer file2md-2024-secure-key" \
  "https://file.medicnex.com/v1/cache/stats"
```

### 3. 文件上传测试
```bash
# 创建测试文件
echo "# 测试文档
这是一个测试文件。" > test.md

# 上传文件
curl -X POST \
  -H "Authorization: Bearer file2md-2024-secure-key" \
  -F "file=@test.md" \
  "https://file.medicnex.com/v1/convert"
```

### 4. 缓存清理
```bash
curl -X POST \
  -H "Authorization: Bearer file2md-2024-secure-key" \
  "https://file.medicnex.com/v1/cache/clear"
```

## 🚨 故障排除

### 常见问题及解决方案：

#### 1. 连接超时或网络错误
```
❌ FAIL API健康检查
    错误: Connection timeout
```
**解决方案：**
- 检查域名 `file.medicnex.com` 是否可访问
- 确认服务是否正在运行
- 检查防火墙设置

#### 2. 认证失败
```
❌ FAIL 缓存统计获取
    状态码: 401
```
**解决方案：**
- 确认 API_KEY 是否正确
- 检查 Authorization header 格式

#### 3. 缓存未启用
```
❌ FAIL 缓存组件检查
    缓存未启用或状态未知
```
**解决方案：**
- 检查 Redis 服务状态
- 确认应用配置中的 Redis 连接参数
- 查看应用日志

#### 4. 缓存不命中
```
❌ FAIL 缓存命中验证
    第二次请求未命中缓存
```
**解决方案：**
- 检查 Redis 服务是否正常
- 确认缓存 TTL 设置
- 查看应用日志中的缓存相关信息

## 📝 测试报告

测试完成后，请记录以下信息：

- [ ] 所有测试项目的通过状态
- [ ] 缓存命中率和性能提升数据
- [ ] 任何错误信息和异常情况
- [ ] Redis 内存使用情况
- [ ] 建议的优化措施

## 🔄 定期测试建议

建议定期执行缓存功能测试：

- **每日**: 快速健康检查和缓存统计
- **每周**: 完整功能测试
- **部署后**: 全面验证测试

通过定期测试确保缓存系统持续稳定运行，提供最佳的用户体验。 