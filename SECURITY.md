# 🔒 安全配置指南

## 概述

本文档描述了 MedicNex File2Markdown 服务的安全配置和最佳实践。

## 已实施的安全措施

### 1. API 密钥管理

✅ **已修复**: 移除了硬编码的 API 密钥
- Docker Compose 现在使用环境变量 `${API_KEY}`
- 启动脚本不再在日志中暴露完整的 API 密钥
- 建议使用强密码生成器创建 32 字符以上的随机密钥

### 2. CORS 安全配置

✅ **已修复**: 限制跨域访问
- 应用级别 CORS 限制为特定域名（如 `https://chat.medicnex.com`）
- `/v1/health` 健康检查端点允许所有来源访问（监控需要）
- 移除了全局通配符 `*` 配置

### 3. 公共API服务

ℹ️ **设计决策**: 作为公共服务，本API不实施速率限制
- 支持全平台多用户并发访问
- 依靠其他安全措施保护服务稳定性
- 通过文件大小和处理时间限制防止滥用

### 4. 文件处理安全

✅ **已修复**: 防止内存耗尽攻击
- 使用流式读取，避免一次性加载大文件到内存
- 设置了严格的文件大小限制
- 添加了分块读取机制

### 5. 存档文件安全

✅ **已实施**: ZIP 炸弹防护
- 验证解压后总大小限制 (500MB)
- 单个文件大小限制 (50MB)
- 文件数量限制 (10,000个)
- 路径遍历攻击防护
- 绝对路径检查

### 6. ImageMagick 安全加固

✅ **已强化**: 资源限制和安全选项
- 内存限制: 50MB
- 磁盘限制: 100MB
- 处理时间限制: 30秒
- 禁用 XML 实体解析
- 限制网络访问
- 单线程处理

## 安全配置

### 环境变量配置

```bash
# 强制要求 API 密钥
REQUIRE_API_KEY=true
API_KEY=your-very-strong-random-api-key-32-chars-or-more

# 限制 CORS 源（生产环境必须配置）
CORS_ORIGINS=https://yourdomain.com,https://app.yourdomain.com

# 文件大小限制
MAX_FILE_SIZE=100  # MB
MAX_TEXT_LINES=50000
MAX_TEXT_CHARS=10000000

# 关闭调试模式
DEBUG=false
ENABLE_DETAILED_LOGGING=false
```

### Docker 安全配置

```yaml
version: '3.8'
services:
  file2markdown:
    build: .
    ports:
      - "8080:8080"
    environment:
      - API_KEY=${API_KEY}  # 从环境变量读取
      - CORS_ORIGINS=${CORS_ORIGINS}
    volumes:
      - /tmp:/tmp:rw,noexec,nosuid,nodev  # 安全挂载
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "1000:1000"  # 非 root 用户运行
```

## 安全最佳实践

### 1. API 密钥管理

- 使用至少 32 字符的随机密钥
- 定期轮换 API 密钥
- 不要在代码或日志中暴露密钥
- 使用环境变量或密钥管理服务

### 2. 网络安全

- 在生产环境中使用 HTTPS
- 配置防火墙限制访问
- 使用反向代理（如 Nginx）
- 配置适当的 CORS 策略

### 3. 文件处理安全

- 验证文件类型和扩展名
- 限制文件大小和数量
- 使用沙箱环境处理不受信任的文件
- 定期清理临时文件

### 4. 监控和日志

- 监控异常的 API 调用模式
- 记录安全相关事件
- 设置告警机制
- 定期审查日志

### 5. 系统安全

- 保持系统和依赖库更新
- 使用最小权限原则
- 定期进行安全审计
- 备份重要配置

## 安全检查清单

- [ ] 已设置强 API 密钥
- [ ] 已配置适当的 CORS 策略
- [ ] 已设置文件大小限制
- [ ] 已配置 HTTPS（生产环境）
- [ ] 已设置监控和告警
- [ ] 已定期更新依赖
- [ ] 已备份配置文件
- [ ] 已配置并发处理限制

## 报告安全问题

如果您发现安全漏洞，请通过以下方式报告：

1. 不要公开披露漏洞
2. 发送详细报告到安全团队
3. 等待确认和修复
4. 遵循负责任的披露原则

## 更新日志

- **2025-06-10**: 修复硬编码 API 密钥问题
- **2025-06-10**: 移除速率限制（公共服务设计）
- **2025-06-10**: 加强文件处理安全
- **2025-06-10**: 强化存档解析安全
- **2025-06-10**: 增强 ImageMagick 安全配置 